<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteorite Data Visualizations</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #5D6D7E;
            color: #fff;
        }
        h1 {
            text-align: center;
            font-weight: bold;
            color: #fff;
            margin: 20px;
        }
        .container {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            box-sizing: border-box;
        }
        .text-content {
            width: 300px;
            margin-right: 20px;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 5px;
            border-radius: 3px;
            pointer-events: none;
            display: none;
        }
        svg {
            border: 1px solid #444;
        }
        .bar-found {
            fill: rgb(247, 220, 111);
        }
        .bar-fell {
            fill: rgb(236, 240, 241);
        }
        .bar-hover-found {
            fill: rgb(255, 223, 132);
        }
        .bar-hover-fell {
            fill: rgb(255, 255, 255);
        }
        .scatter {
            fill: #ff4d4d;
        }
        .label {
            font-size: 12px;
            fill: #fff;
        }
        .axis-label {
            font-size: 14px;
            font-weight: bold;
            fill: #fff;
        }
        .chart-svg {
            margin-bottom: 20px;
        }
        #stacked-chart-container {
            overflow-x: auto;
            white-space: nowrap;
        }
        .legend {
            font-size: 14px;
            fill: #fff;
        }
        .legend rect {
            stroke-width: 2px;
        }
    </style>
</head>
<body>
    <h1>Meteorite Data Visualizations</h1>
    <div class="container">
        <div class="text-content">
            <h2>The Heaviest Meteorites Ever Recorded</h2>
            <p>According to National Geographic, the largest meteorite ever discovered on Earth is the Hoba meteorite, found in Namibia in 1920. 
                Weighing approximately 54,000 kilograms (119,000 pounds), the Hoba meteorite is so massive that it remains in its original location. 
                Its enormous size and weight make it impossible to move, and it has been preserved exactly where it was discovered. 
                This remarkable meteorite offers a unique opportunity to study an extraterrestrial object in its natural setting.
            </p>
        </div>
        <div id="horizontal-chart-container">
            <!-- Horizontal bar chart will be appended here -->
        </div>
    </div>
    <div class="container">
        <div class="text-content">
            <h2>Meteorite Discoveries Over Time</h2>
            <p>
                There are several factors contributing to the increase in meteorite finds over recent years. 
                Primarily, climate change and advancements in transportation technology have played significant roles. 
                The melting of Arctic ice has uncovered numerous meteorite specimens that were previously inaccessible. 
                Additionally, our rapid technological progress has enabled us to retrieve meteorites from the Moon's craters. 
                This combination of environmental and technological changes has greatly enhanced our ability to discover and study meteorites. 
            </p>
        </div>
        <div id="stacked-chart-container">
            <!-- Stacked bar chart will be appended here -->
        </div>
    </div>
    <div class="tooltip"></div>
    <script>
        // Define dimensions and margins
        const margin = { top: 20, right: 200, bottom: 100, left: 150 },
              width = 1500 - margin.left - margin.right,
              height = 600 - margin.top - margin.bottom;

        // Create SVG containers
        const horizontalContainer = d3.select("#horizontal-chart-container");
        const stackedContainer = d3.select("#stacked-chart-container");

        // Create a tooltip
        const tooltip = d3.select(".tooltip");

        // Load and process data
        Promise.all([
            d3.csv('https://skillet64.github.io/498/biggest.csv', d => ({
                name: d.name,
                mass: +d['mass (g) (Sum)'] // Ensure the mass is parsed as a number
            })),
            d3.csv('https://skillet64.github.io/498/ml-Meteorite_Landings Pivot-ml-Meteorite_Landings Pivot.csv', d => ({
                year: +d.fall || 1399, // Use a default year if missing
                Fell: +d.Fell || 0,    // Ensure numerical values
                Found: +d.Found || 0,
                'Grand Total': (+d.Fell || 0) + (+d.Found || 0)
            }))
        ]).then(([biggestData, pivotData]) => {

            // Log the raw data for debugging
            console.log("Biggest Data:", biggestData);
            console.log("Pivot Data:", pivotData);

            // Process the data for the horizontal bar chart
            biggestData.sort((a, b) => b.mass - a.mass);

            // Log processed data
            console.log("Processed Biggest Data:", biggestData);

            const x1 = d3.scaleLinear()
                .domain([0, d3.max(biggestData, d => d.mass)])
                .range([0, width]);

            const y1 = d3.scaleBand()
                .domain(biggestData.map(d => d.name))
                .range([0, height])
                .padding(0.1);

            const horizontalSvg = horizontalContainer.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("class", "chart-svg");

            horizontalSvg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`)
                .selectAll(".bar")
                .data(biggestData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", 0)
                .attr("y", d => y1(d.name))
                .attr("width", d => x1(d.mass))
                .attr("height", y1.bandwidth())
                .style("fill", "#fff")
                .on("mouseover", function(event, d) {
                    d3.select(this)
                        .style("fill", d.mass > 0 ? "rgb(255, 223, 132)" : "rgb(255, 255, 255)");
                    tooltip
                        .style("display", "block")
                        .html(`Name: ${d.name}<br>Mass: ${d.mass} g`);
                })
                .on("mousemove", function(event) {
                    tooltip
                        .style("top", (event.pageY + 5) + "px")
                        .style("left", (event.pageX + 5) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this)
                        .style("fill", "#fff");
                    tooltip.style("display", "none");
                });

            // Process the data for the stacked bar chart
            pivotData = pivotData.filter(d => d.year !== "Unknown" && d['Grand Total'] > 0);

            // Bin years into 100-year intervals
            const binWidth = 100;
            const binnedData = d3.group(
                pivotData,
                d => Math.floor(d.year / binWidth) * binWidth
            );

            // Create the binned array with aggregated totals
            const binnedArray = Array.from(binnedData, ([year, values]) => ({
                year: `${year}-${year + binWidth - 1}`,
                Fell: d3.sum(values, d => d.Fell),
                Found: d3.sum(values, d => d.Found),
                GrandTotal: d3.sum(values, d => d['Grand Total'])
            }));

            // Log the processed binned data
            console.log("Processed Binned Data:", binnedArray);

            // Define the scales for the stacked bar chart
            const x2 = d3.scaleBand()
                .domain(binnedArray.map(d => d.year))
                .range([0, width])
                .padding(0.2);

            const y2 = d3.scaleLog()
                .domain([1, d3.max(binnedArray, d => d.GrandTotal)])
                .nice()
                .range([height, 0]);

            const color = d3.scaleOrdinal()
                .domain(['Found', 'Fell'])
                .range(['#1f77b4', '#ff7f0e']);

            const stackedSvg = stackedContainer.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("class", "chart-svg");

            const stackedG = stackedSvg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Define the stack layout
            const stack = d3.stack()
                .keys(['Found', 'Fell'])
                .order(d3.stackOrderNone)
                .offset(d3.stackOffsetNone);

            // Create the series with conditional bars based on non-zero values
            const series = stack(binnedArray.map(d => ({
                year: d.year,
                Found: d.Found > 0 ? d.Found : 0, // Ensure zero for non-existent data
                Fell: d.Fell > 0 ? d.Fell : 0
            })));

            // Add X axis to the stacked bar chart
            stackedG.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x2).tickSize(0))
                .append("text")
                .attr("class", "axis-label")
                .attr("x", width)
                .attr("y", 40)
                .attr("fill", "#fff")
                .attr("text-anchor", "end")
                .text("Year Range");

            // Add Y axis to the stacked bar chart
            stackedG.append("g")
                .call(d3.axisLeft(y2).ticks(10, ".0s"))
                .append("text")
                .attr("class", "axis-label")
                .attr("x", -margin.left)
                .attr("y", -10)
                .attr("fill", "#fff")
                .attr("text-anchor", "start")
                .text("Meteorite Count");

            // Add the stacked bars
            stackedG.selectAll(".layer")
                .data(series)
                .enter().append("g")
                .attr("class", "layer")
                .attr("fill", d => color(d.key))
                .selectAll("rect")
                .data(d => d.filter(d => d[1] - d[0] > 0)) // Filter out zero-height bars
                .enter().append("rect")
                .attr("x", d => x2(d.data.year))
                .attr("y", d => y2(d[1])) // Set the y position
                .attr("width", x2.bandwidth())
                .attr("height", d => {
                    const rectHeight = y2(d[0]) - y2(d[1]); // Calculate height
                    return isFinite(rectHeight) && rectHeight > 0 ? rectHeight : 0; // Ensure valid height
                })
                .style("fill", d => color(d.key))
                .on("mouseover", function(event, d) {
                    d3.select(this)
                        .style("fill", d.key === 'Found' ? 'rgb(255, 223, 132)' : 'rgb(255, 255, 255)');
                    tooltip
                        .style("display", "block")
                        .html(`Year Range: ${d.data.year}<br>Total: ${d[1] - d[0]}`);
                })
                .on("mousemove", function(event) {
                    tooltip
                        .style("top", (event.pageY + 5) + "px")
                        .style("left", (event.pageX + 5) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this)
                        .style("fill", d => color(d.key));
                    tooltip.style("display", "none");
                });

            // Add color legend
            const legendWidth = 200;
            const legendHeight = 100;
            const legend = stackedSvg.append("g")
                .attr("transform", `translate(${width + 20}, 0)`);

            legend.selectAll("rect")
                .data(color.domain())
                .enter().append("rect")
                .attr("x", 0)
                .attr("y", (d, i) => i * 25)
                .attr("width", 20)
                .attr("height", 20)
                .style("fill", d => color(d))
                .style("stroke", "#fff");

            legend.selectAll("text")
                .data(color.domain())
                .enter().append("text")
                .attr("x", 30)
                .attr("y", (d, i) => i * 25 + 15)
                .attr("class", "legend")
                .text(d => d);
                
        }).catch(error => console.error('Error loading or processing data:', error));
    </script>
</body>
</html>
