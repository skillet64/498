<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteorite Visualizations</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 90%;
            margin: 20px auto;
        }
        .chart-container {
            margin-bottom: 40px;
        }
        .chart-svg {
            background-color: #34495e;
        }
        .bar {
            fill: #3498db;
        }
        .bar:hover {
            fill: #2980b9;
        }
        .axis-label {
            font-size: 12px;
            fill: #ecf0f1;
        }
        .legend {
            margin: 20px 0;
        }
        .legend-item {
            display: inline-block;
            width: 100px;
            height: 20px;
            margin-right: 10px;
            color: #ecf0f1;
            line-height: 20px;
        }
        #tooltip {
            position: absolute;
            background-color: #fff;
            color: #000;
            padding: 10px;
            border-radius: 4px;
            pointer-events: none;
            display: none;
            font-size: 12px;
        }
        .meteorite {
            fill: #e74c3c;
        }
    </style>
</head>
<body>
    <div id="tooltip"></div>
    <div class="container">
        <div id="horizontal-chart" class="chart-container"></div>
        <div id="stacked-chart" class="chart-container"></div>
        <div id="globe" class="chart-container"></div>
        <div id="legend" class="legend"></div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script>
        const width = 960;
        const height = 500;
        const margin = {top: 20, right: 30, bottom: 40, left: 40};
        const colorScheme = {
            bar: '#3498db',
            barHover: '#2980b9',
            meteorite: '#e74c3c'
        };

        // Tooltip setup
        const tooltip = d3.select("#tooltip");

        // Fetch data
        Promise.all([
            d3.csv('https://skillet64.github.io/498/biggest.csv', d => ({
                name: d.name,
                mass: +d['mass (g) (Sum)'] || 0
            })),
            d3.csv('https://skillet64.github.io/498/ml-Meteorite_Landings Pivot-ml-Meteorite_Landings Pivot.csv', d => ({
                year: +d.year || 1399,
                Fell: +d.Fell || 0,
                Found: +d.Found || 0,
                'Grand Total': (+d.Fell || 0) + (+d.Found || 0)
            })),
            d3.csv('https://skillet64.github.io/498/Sheet 1-ml-Meteorite_Landings.csv', d => ({
                name: d.name,
                lat: +d.reclat || NaN,
                lon: +d.reclong || NaN
            })),
            d3.json('https://skillet64.github.io/498/land-110m.json'),
            d3.json('https://skillet64.github.io/498/land-50m.json')
        ]).then(([biggestData, pivotData, meteorites, land110m, land50m]) => {
            
            // Horizontal Bar Chart
            biggestData.sort((a, b) => b.mass - a.mass);

            const x1 = d3.scaleLinear()
                .domain([0, d3.max(biggestData, d => d.mass)])
                .range([0, width - margin.left - margin.right]);

            const y1 = d3.scaleBand()
                .domain(biggestData.map(d => d.name))
                .range([0, height - margin.top - margin.bottom])
                .padding(0.1);

            const horizontalSvg = d3.select("#horizontal-chart").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("class", "chart-svg");

            horizontalSvg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`)
                .selectAll(".bar")
                .data(biggestData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", 0)
                .attr("y", d => y1(d.name))
                .attr("width", d => x1(d.mass))
                .attr("height", y1.bandwidth())
                .style("fill", colorScheme.bar)
                .on("mouseover", function(event, d) {
                    d3.select(this).style("fill", colorScheme.barHover);
                    tooltip
                        .style("display", "block")
                        .html(`Name: ${d.name}<br>Mass: ${d.mass} g`);
                })
                .on("mousemove", function(event) {
                    tooltip
                        .style("top", (event.pageY + 5) + "px")
                        .style("left", (event.pageX + 5) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("fill", colorScheme.bar);
                    tooltip.style("display", "none");
                });

            horizontalSvg.append("g")
                .attr("transform", `translate(${margin.left},${height - margin.bottom})`)
                .call(d3.axisBottom(x1).ticks(10, ",.0s"))
                .append("text")
                .attr("class", "axis-label")
                .attr("x", width - margin.left - margin.right)
                .attr("y", 40)
                .attr("text-anchor", "end")
                .attr("fill", "#ecf0f1")
                .text("Mass (g)");

            horizontalSvg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`)
                .call(d3.axisLeft(y1))
                .append("text")
                .attr("class", "axis-label")
                .attr("x", -40)
                .attr("y", -10)
                .attr("text-anchor", "end")
                .attr("fill", "#ecf0f1")
                .text("Meteorite Name");

            // Stacked Bar Chart
            const bins = d3.bin()
                .value(d => d.year)
                .thresholds(d3.range(1400, 2100, 100))(pivotData);

            const x2 = d3.scaleBand()
                .domain(bins.map(b => `${b.x0}-${b.x1}`))
                .range([0, width - margin.left - margin.right])
                .padding(0.2);

            const y2 = d3.scaleLinear()
                .domain([0, d3.max(pivotData, d => d['Grand Total'])])
                .range([height - margin.top - margin.bottom, 0]);

            const stackedSvg = d3.select("#stacked-chart").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("class", "chart-svg");

            stackedSvg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`)
                .selectAll(".bar")
                .data(bins)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x2(`${d.x0}-${d.x1}`))
                .attr("y", d => y2(d3.sum(d, e => e['Grand Total'])))
                .attr("width", x2.bandwidth())
                .attr("height", d => height - margin.top - margin.bottom - y2(d3.sum(d, e => e['Grand Total'])))
                .style("fill", colorScheme.bar);

            stackedSvg.append("g")
                .attr("transform", `translate(${margin.left},${height - margin.bottom})`)
                .call(d3.axisBottom(x2))
                .append("text")
                .attr("class", "axis-label")
                .attr("x", width - margin.left - margin.right)
                .attr("y", 40)
                .attr("text-anchor", "end")
                .attr("fill", "#ecf0f1")
                .text("Year (Bins)");

            stackedSvg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`)
                .call(d3.axisLeft(y2))
                .append("text")
                .attr("class", "axis-label")
                .attr("x", -40)
                .attr("y", -10)
                .attr("text-anchor", "end")
                .attr("fill", "#ecf0f1")
                .text("Number of Meteorites");

            // Globe Visualization
            const projection = d3.geoOrthographic()
                .scale(150)
                .translate([width / 2, height / 2])
                .rotate([0, -30]);

            const path = d3.geoPath().projection(projection);

            const globeSvg = d3.select("#globe").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("class", "chart-svg");

            globeSvg.append("path")
                .datum(topojson.feature(land110m, land110m.objects.land))
                .attr("class", "land")
                .attr("d", path);

            globeSvg.selectAll(".meteorite")
                .data(meteorites.filter(d => !isNaN(d.lat) && !isNaN(d.lon)))
                .enter().append("circle")
                .attr("class", "meteorite")
                .attr("cx", d => projection([d.lon, d.lat])[0])
                .attr("cy", d => projection([d.lon, d.lat])[1])
                .attr("r", 2)
                .style("fill", colorScheme.meteorite);
            
            // Legend
            const legend = d3.select("#legend");

            legend.append("div")
                .attr("class", "legend-item")
                .style("background-color", colorScheme.bar)
                .text("Meteorite Mass");

            legend.append("div")
                .attr("class", "legend-item")
                .style("background-color", colorScheme.barHover)
                .text("Hover Highlight");

            legend.append("div")
                .attr("class", "legend-item")
                .style("background-color", colorScheme.meteorite)
                .text("Meteorite Locations");

        }).catch(error => console.error(error));
    </script>
</body>
</html>
