<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteorite Landings</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/versor@0.2/dist/versor.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        body { margin: 0; }
        .tooltip { 
            position: absolute; 
            background: rgba(0, 0, 0, 0.7); 
            color: #fff; 
            padding: 5px; 
            border-radius: 3px; 
            pointer-events: none; 
            display: none; 
        }
        .chart-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .chart-row {
            width: 100%;
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        .chart {
            margin: 0 10px;
        }
        .text-container {
            width: 20%;
            padding: 10px;
            box-sizing: border-box;
        }
        .text-left {
            text-align: left;
        }
        .text-right {
            text-align: right;
        }
        .bar-chart-container,
        .stacked-bar-chart-container {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        .bar-chart {
            height: 300px;
            width: 50%;
        }
        .stacked-bar-chart {
            height: 300px;
            width: 50%;
        }
        .map-container {
            width: 100%;
            height: 50vh; /* Adjusted height for the map */
            position: relative;
        }
        #mapCanvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="tooltip"></div>
    <div class="chart-container">
        <div class="chart-row">
            <div class="text-container text-left">
                <h2>The Heaviest Meteorites Ever Recorded</h2>
                <p>According to National Geographic, the largest meteorite ever discovered on Earth is the Hoba meteorite, found in Namibia in 1920. 
                    Weighing approximately 54,000 kilograms (119,000 pounds), the Hoba meteorite is so massive that it remains in its original location. 
                    Its enormous size and weight make it impossible to move, and it has been preserved exactly where it was discovered. 
                    This remarkable meteorite offers a unique opportunity to study an extraterrestrial object in its natural setting.
                </p>
            </div>
            <div class="chart bar-chart-container">
                <div class="bar-chart"></div>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart stacked-bar-chart-container">
                <div class="stacked-bar-chart"></div>
            </div>
            <div class="text-container text-right">
                <h2>Number of Finds Over Time</h2>
                <p>
                    There are several factors contributing to the increase in meteorite finds over recent years. 
                    Primarily, climate change and advancements in transportation technology have played significant roles. 
                    The melting of Arctic ice has uncovered numerous meteorite specimens that were previously inaccessible. 
                    Additionally, our rapid technological progress has enabled us to retrieve meteorites from the Moon's craters. 
                    This combination of environmental and technological changes has greatly enhanced our ability to discover and study meteorites. 
                </p>
            </div>
        </div>
    </div>

    <div class="map-container">
        <canvas id="mapCanvas"></canvas>
    </div>
    
    <script>
        const chartContainerHeight = 600; // Combined height for the charts section
        const width = window.innerWidth;
        const height = window.innerHeight - chartContainerHeight; // Height for the map
        const radius = Math.min(width, height) / 2.2; // Adjust scale for the globe

        const canvas = d3.select("#mapCanvas")
            .attr("width", width)
            .attr("height", height);

        const context = canvas.node().getContext("2d");

        const projection = d3.geoOrthographic()
            .translate([width / 2, height / 2])
            .scale(radius);

        const path = d3.geoPath().projection(projection).context(context);

        let landData, countryBorders, pinsData, largestData, fellFoundData;

        function render() {
            context.clearRect(0, 0, width, height);

            context.beginPath();
            path({type: "Sphere"});
            context.fillStyle = "#0000ff";
            context.fill();

            context.beginPath();
            path(landData);
            context.fillStyle = "#bada55";
            context.fill();

            if (countryBorders) {
                context.beginPath();
                path(countryBorders);
                context.strokeStyle = "#333";
                context.lineWidth = 1;
                context.stroke();
            }

            drawBubbleMap();
        }

        function drawBubbleMap() {
            const aggregatedData = d3.rollups(
                pinsData,
                v => v.length,
                d => [d.reclong, d.reclat]
            ).map(([coords, count]) => ({
                coords,
                count
            }));

            context.globalAlpha = 0.7;
            context.fillStyle = "#ff5733";

            aggregatedData.forEach(d => {
                const [longitude, latitude] = d.coords;
                const [x, y] = projection([+longitude, +latitude]);
                if (x && y) {
                    const maxBubbleSize = 20;
                    const minBubbleSize = 5;
                    const radius = Math.max(minBubbleSize, Math.min(maxBubbleSize, Math.sqrt(d.count)));

                    context.beginPath();
                    context.arc(x, y, radius, 0, 2 * Math.PI);
                    context.fillStyle = "#ff5733";
                    context.fill();
                }
            });
        }

        function loadData() {
            Promise.all([
                d3.json('https://skillet64.github.io/498/land-50m.json'),
                d3.json('https://skillet64.github.io/498/land-110m.json'),
                d3.csv('https://skillet64.github.io/498/Sheet 1-ml-Meteorite_Landings.csv'),
                d3.csv('https://skillet64.github.io/498/biggest.csv'),
                d3.csv('https://skillet64.github.io/498/ml-Meteorite_Landings Pivot-ml-Meteorite_Landings Pivot.csv')
            ]).then(([land50, land110, mlData, biggestData, fellFoundData]) => {
                console.log('Land 50m:', land50);
                console.log('Land 110m:', land110);

                landData = topojson.feature(land50, land50.objects.land);
                countryBorders = topojson.feature(land110, land110.objects.countries);
                pinsData = mlData;
                largestData = biggestData;
                fellFoundData = fellFoundData || [];

                render();
                drawBarChart();
                drawStackedBarChart();
            }).catch(error => {
                console.error('Error loading data:', error);
            });
        }

        function drawBarChart() {
            const data = largestData.map(d => ({
                name: d.name,
                mass: +d['mass (g) (Sum)']
            }));

            const svg = d3.select('.bar-chart').append('svg')
                .attr('width', '100%')
                .attr('height', '100%');

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.mass)])
                .nice()
                .range([0, d3.select('.bar-chart').node().getBoundingClientRect().width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.name))
                .range([0, d3.select('.bar-chart').node().getBoundingClientRect().height])
                .padding(0.1);

            svg.selectAll('.bar')
                .data(data)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', 0)
                .attr('y', d => y(d.name))
                .attr('width', d => x(d.mass))
                .attr('height', y.bandwidth())
                .attr('fill', '#69b3a2');

            svg.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0,${d3.select('.bar-chart').node().getBoundingClientRect().height})`)
                .call(d3.axisBottom(x));

            svg.append('g')
                .attr('class', 'y-axis')
                .call(d3.axisLeft(y));
        }

        function drawStackedBarChart() {
            const data = fellFoundData.map(d => ({
                year: d.year,
                finds: +d.finds,
                falls: +d.falls
            }));

            const svg = d3.select('.stacked-bar-chart').append('svg')
                .attr('width', '100%')
                .attr('height', '100%');

            const x = d3.scaleBand()
                .domain(data.map(d => d.year))
                .range([0, d3.select('.stacked-bar-chart').node().getBoundingClientRect().width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.finds + d.falls)])
                .nice()
                .range([d3.select('.stacked-bar-chart').node().getBoundingClientRect().height, 0]);

            const color = d3.scaleOrdinal()
                .domain(['Finds', 'Falls'])
                .range(['#1f77b4', '#ff7f0e']);

            svg.selectAll('.bar')
                .data(data)
                .enter().append('g')
                .attr('class', 'bar')
                .attr('transform', d => `translate(${x(d.year)},0)`)
                .selectAll('rect')
                .data(d => [
                    { type: 'finds', value: d.finds },
                    { type: 'falls', value: d.falls }
                ])
                .enter().append('rect')
                .attr('x', 0)
                .attr('y', d => y(d3.sum(data.filter(d => d.year === d.year), d => d.value)) - y(d.value))
                .attr('width', x.bandwidth())
                .attr('height', d => y(d3.sum(data.filter(d => d.year === d.year), d => d.value)) - y(d.value))
                .attr('fill', d => color(d.type));

            svg.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0,${d3.select('.stacked-bar-chart').node().getBoundingClientRect().height})`)
                .call(d3.axisBottom(x));

            svg.append('g')
                .attr('class', 'y-axis')
                .call(d3.axisLeft(y));
        }

        window.onload = loadData;
    </script>
</body>
</html>
