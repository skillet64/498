<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualizations</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/versor@0.2/dist/versor.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        .chart {
            margin-bottom: 20px;
        }
        .bar { fill: steelblue; }
        .axis-label { font-weight: bold; }
        .legend rect { fill: steelblue; }
        svg { border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Stacked Bar Chart -->
        <svg id="stackedBarChart" width="800" height="400"></svg>
        <!-- Horizontal Bar Chart -->
        <svg id="horizontalBarChart" width="800" height="400"></svg>
        <!-- Globe -->
        <svg id="globe" width="800" height="600"></svg>
    </div>

    <script>
        // Stacked Bar Chart
        const stackedBarSvg = d3.select("#stackedBarChart");
        const stackedBarMargin = {top: 20, right: 20, bottom: 50, left: 70};
        const stackedBarWidth = +stackedBarSvg.attr("width") - stackedBarMargin.left - stackedBarMargin.right;
        const stackedBarHeight = +stackedBarSvg.attr("height") - stackedBarMargin.top - stackedBarMargin.bottom;
        const stackedBarG = stackedBarSvg.append("g").attr("transform", `translate(${stackedBarMargin.left},${stackedBarMargin.top})`);

        d3.csv("ml-Meteorite_Landings Pivot-ml-Meteorite_Landings Pivot.csv", function(d, i, columns) {
            if (i > 1) { // Skip the first two rows
                for (let i = 0; i < columns.length; i++) {
                    d[columns[i]] = +d[columns[i]] || 0;
                }
                return d;
            }
        }).then(data => {
            const parsedData = data.map(d => ({
                year: d.Fell,
                fell: +d.Fell || 0
            }));

            const x = d3.scaleLinear()
                .domain([0, d3.max(parsedData, d => d.fell)])
                .range([0, stackedBarWidth]);

            const y = d3.scaleBand()
                .domain(parsedData.map(d => d.year))
                .rangeRound([0, stackedBarHeight])
                .padding(0.1);

            stackedBarG.append("g")
                .selectAll("rect")
                .data(parsedData)
                .enter().append("rect")
                .attr("x", 0)
                .attr("y", d => y(d.year))
                .attr("width", d => x(d.fell))
                .attr("height", y.bandwidth())
                .attr("fill", "steelblue");

            stackedBarG.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${stackedBarHeight})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format("~s")))
                .append("text")
                .attr("x", stackedBarWidth / 2)
                .attr("y", 40)
                .attr("text-anchor", "middle")
                .style("font-weight", "bold")
                .text("Number of Meteorites Found");

            stackedBarG.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y).tickSize(0))
                .append("text")
                .attr("x", -stackedBarMargin.left)
                .attr("y", -10)
                .attr("text-anchor", "start")
                .style("font-weight", "bold")
                .text("Year");
        }).catch(error => {
            console.error('Error loading CSV for stacked bar chart:', error);
        });

        // Horizontal Bar Chart
        const horizontalBarSvg = d3.select("#horizontalBarChart");
        const horizontalBarMargin = {top: 20, right: 20, bottom: 50, left: 70};
        const horizontalBarWidth = +horizontalBarSvg.attr("width") - horizontalBarMargin.left - horizontalBarMargin.right;
        const horizontalBarHeight = +horizontalBarSvg.attr("height") - horizontalBarMargin.top - horizontalBarMargin.bottom;
        const horizontalBarG = horizontalBarSvg.append("g").attr("transform", `translate(${horizontalBarMargin.left},${horizontalBarMargin.top})`);

        d3.csv("biggest.csv").then(data => {
            data.forEach(d => {
                d['mass (g) (Sum)'] = +d['mass (g) (Sum)'];
            });

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => d['mass (g) (Sum)'])])
                .range([0, horizontalBarWidth]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.name))
                .rangeRound([0, horizontalBarHeight])
                .padding(0.1);

            horizontalBarG.append("g")
                .selectAll("rect")
                .data(data)
                .enter().append("rect")
                .attr("x", 0)
                .attr("y", d => y(d.name))
                .attr("width", d => x(d['mass (g) (Sum)']))
                .attr("height", y.bandwidth())
                .attr("fill", "steelblue");

            horizontalBarG.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${horizontalBarHeight})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format(".0s")))
                .append("text")
                .attr("x", horizontalBarWidth / 2)
                .attr("y", 40)
                .attr("text-anchor", "middle")
                .style("font-weight", "bold")
                .text("Mass (g)");

            horizontalBarG.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("x", -horizontalBarMargin.left)
                .attr("y", -10)
                .attr("text-anchor", "start")
                .style("font-weight", "bold")
                .text("Meteorite Name");
        }).catch(error => {
            console.error('Error loading CSV for horizontal bar chart:', error);
        });

        // Globe
        const globeSvg = d3.select("#globe");
        const globeMargin = {top: 20, right: 20, bottom: 20, left: 20};
        const globeWidth = +globeSvg.attr("width") - globeMargin.left - globeMargin.right;
        const globeHeight = +globeSvg.attr("height") - globeMargin.top - globeMargin.bottom;

        const projection = d3.geoOrthographic()
            .translate([globeWidth / 2, globeHeight / 2])
            .scale(globeWidth / 2)
            .clipAngle(90);

        const path = d3.geoPath().projection(projection);

        const globeG = globeSvg.append("g").attr("transform", `translate(${globeMargin.left},${globeMargin.top})`);

        Promise.all([
            d3.json("https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/countries.geojson"),
            d3.json("https://skillet64.github.io/498/world-110m.json")
        ]).then(([worldData, countriesData]) => {
            const land = topojson.feature(worldData, worldData.objects.land);

            globeG.append("path")
                .datum(land)
                .attr("class", "land")
                .attr("d", path)
                .attr("fill", "#ccc")
                .attr("stroke", "#333")
                .attr("stroke-width", 0.5);

            globeG.append("path")
                .datum(topojson.mesh(countriesData, countriesData.objects.countries, (a, b) => a !== b))
                .attr("class", "boundary")
                .attr("d", path)
                .attr("fill", "none")
                .attr("stroke", "#000")
                .attr("stroke-width", 1);

            d3.select(window).on("mousemove", function(event) {
                const [x, y] = d3.pointer(event);
                projection.rotate([x / globeWidth * 360 - 180, -y / globeHeight * 360 + 90]);
                globeSvg.selectAll("path").attr("d", path);
            });

        }).catch(error => {
            console.error('Error loading GeoJSON for globe:', error);
        });

    </script>
</body>
</html>
